#!/bin/sh

set -eu

url=$1

# Unset variables (alternative: curl --insecure) because youtube-irc-bot
# with SSL IRC connection contaminates the environment with env vars that
# break curl to https://www.youtube.com/:
# +SSL_CERT_DIR=/etc/pki/tls/certs
# +SSL_CERT_FILE=/etc/pki/tls/certs/ca-bundle.crt
unset SSL_CERT_DIR
unset SSL_CERT_FILE

#exec curl -sL --proxy-insecure -- "$url"

temp_out="$(mktemp get-youtube-page.XXXXXXXXX)"

for i in $(seq 1 6); do
	proxy="$(shuf -n 1 ~/.config/youtube-dl/proxies)"
	# Use --fail to get a non-0 exit status on 429/503 HTTP response
	curl --fail --max-time 7 -sL --proxy-insecure --proxy "$proxy" -- "$url" > "$temp_out" && break || continue
done

cat "$temp_out"
rm -f "$temp_out"
