#!/usr/bin/env bash

enable -f /run/current-system/sw/lib/bash/sleep sleep

for i in $(ts ls -j ~/YouTube | shuf); do
	file_count=$(ts ls -j ~/YouTube/$i | wc -l)
	if [[ $file_count -gt 0 ]]; then
		echo "Skipping $i which has $file_count files"
		continue
	fi
	num_downloaders=$(tmux ls | grep -P '^YouTube-' | wc -l)
	while [[ $num_downloaders -ge 25 ]]; do
		echo "Downloading: $(tmux ls | grep -P '^YouTube-' | grep -o -P '^YouTube-[^:]+' | sed -r 's,^YouTube-,,g' | tr '\n' ' ')"
		sleep 3
		num_downloaders=$(tmux ls | grep -P '^YouTube-' | wc -l)
	done
	echo "Starting $i"
	grab-youtube-channel "$i" || true
	sleep 0.05
done
