#!/usr/bin/env bash

set -eu

# Return exit code 0 is safe to start, else non-0.

# For DEV scaleways on EPYC
max=20
min_disk=8000000000
if [[ $HOSTNAME = "finhdd1" ]]; then
	min_disk=150000000000
	max=30
elif [[ $HOSTNAME = "finssd1" ]]; then
	min_disk=15000000000
	max=33
elif [[ $HOSTNAME = "parhdd1" ]]; then
	max=24
elif [[ $HOSTNAME = "parssd1" ]]; then
	max=24
elif [[ $HOSTNAME = "scale9" ]]; then
	max=13
elif [[ $HOSTNAME = "scale11" ]]; then
	max=13
elif [[ $HOSTNAME = "scale12" ]]; then
	max=13
elif [[ $HOSTNAME = "scale13" ]]; then
	max=13
fi

[[ $(pgrep 'youtube-dl' | wc -l) -lt $max ]]
[[ $(pgrep 'node'       | wc -l) -lt $max ]]

mkdir -p /home/at/YouTube
kb_disk_free=$(get-free-space-for-youtube)
[[ $kb_disk_free -gt $min_disk ]]
